# üîí –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–ü–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#–ø–æ–ª–∏—Ç–∏–∫–∞-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
- [–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è](#–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è-–∏-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)
- [–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö](#—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ-–¥–∞–Ω–Ω—ã—Ö)
- [–ó–∞—â–∏—Ç–∞ API](#–∑–∞—â–∏—Ç–∞-api)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
- [–ê—É–¥–∏—Ç –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–∞—É–¥–∏—Ç-–∏-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
- [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—Å–µ–∫—Ä–µ—Ç–∞–º–∏)
- [–ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫](#–∑–∞—â–∏—Ç–∞-–æ—Ç-–∞—Ç–∞–∫)
- [Compliance –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ](#compliance-–∏-—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ)
- [Incident Response](#incident-response)
- [–ß–µ–∫–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#—á–µ–∫–ª–∏—Å—Ç-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

## –ü–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **Defense in Depth** - –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞
2. **Least Privilege** - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏
3. **Zero Trust** - –ù—É–ª–µ–≤–æ–µ –¥–æ–≤–µ—Ä–∏–µ
4. **Security by Design** - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —ç—Ç–∞–ø–µ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
5. **Continuous Security** - –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π

–ï—Å–ª–∏ –≤—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ —É—è–∑–≤–∏–º–æ—Å—Ç—å:

1. **–ù–ï** –ø—É–±–ª–∏–∫—É–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—É–±–ª–∏—á–Ω–æ
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –Ω–∞ security@mixbase.ru
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ PGP –∫–ª—é—á –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (ID: 0x1234ABCD)
4. –û–∂–∏–¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 48 —á–∞—Å–æ–≤
5. –ü–æ–ª—É—á–∏—Ç–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∏ –≤–æ–∑–º–æ–∂–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ

## –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

```python
# security/jwt_auth.py
import jwt
from datetime import datetime, timedelta
from typing import Optional, Dict, Any

class JWTManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä JWT —Ç–æ–∫–µ–Ω–æ–≤"""
    
    def __init__(self, secret_key: str, algorithm: str = "HS256"):
        self.secret_key = secret_key
        self.algorithm = algorithm
        self.token_expiry = timedelta(hours=1)
        self.refresh_expiry = timedelta(days=7)
        
    def generate_token(self, user_id: str, claims: Dict[str, Any] = None) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è access —Ç–æ–∫–µ–Ω–∞"""
        payload = {
            "user_id": user_id,
            "exp": datetime.utcnow() + self.token_expiry,
            "iat": datetime.utcnow(),
            "type": "access"
        }
        
        if claims:
            payload.update(claims)
            
        return jwt.encode(payload, self.secret_key, algorithm=self.algorithm)
        
    def generate_refresh_token(self, user_id: str) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è refresh —Ç–æ–∫–µ–Ω–∞"""
        payload = {
            "user_id": user_id,
            "exp": datetime.utcnow() + self.refresh_expiry,
            "iat": datetime.utcnow(),
            "type": "refresh"
        }
        
        return jwt.encode(payload, self.secret_key, algorithm=self.algorithm)
        
    def verify_token(self, token: str) -> Optional[Dict[str, Any]]:
        """–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞"""
        try:
            payload = jwt.decode(
                token, 
                self.secret_key, 
                algorithms=[self.algorithm]
            )
            return payload
        except jwt.ExpiredSignatureError:
            raise Exception("–¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫")
        except jwt.InvalidTokenError:
            raise Exception("–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω")
```

### OAuth 2.0 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

```python
# security/oauth.py
from authlib.integrations.fastapi_client import OAuth
from fastapi import FastAPI, Request
from fastapi.responses import RedirectResponse

app = FastAPI()
oauth = OAuth(app)

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
oauth.register(
    name='google',
    client_id='your-client-id',
    client_secret='your-client-secret',
    server_metadata_url='https://accounts.google.com/.well-known/openid-configuration',
    client_kwargs={'scope': 'openid email profile'}
)

@app.get('/login/{provider}')
async def login(provider: str, request: Request):
    """–ò–Ω–∏—Ü–∏–∞—Ü–∏—è OAuth flow"""
    redirect_uri = request.url_for('callback', provider=provider)
    return await oauth.create_client(provider).authorize_redirect(
        request, redirect_uri
    )

@app.get('/callback/{provider}')
async def callback(provider: str, request: Request):
    """OAuth callback"""
    token = await oauth.create_client(provider).authorize_access_token(request)
    user_info = token.get('userinfo')
    
    # –°–æ–∑–¥–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    jwt_token = jwt_manager.generate_token(
        user_id=user_info['sub'],
        claims={'email': user_info['email']}
    )
    
    return {"access_token": jwt_token}
```

### Role-Based Access Control (RBAC)

```python
# security/rbac.py
from enum import Enum
from typing import List, Set
from functools import wraps

class Role(Enum):
    """–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    ADMIN = "admin"
    USER = "user"
    VIEWER = "viewer"
    API_CLIENT = "api_client"

class Permission(Enum):
    """–†–∞–∑—Ä–µ—à–µ–Ω–∏—è"""
    READ = "read"
    WRITE = "write"
    DELETE = "delete"
    ADMIN = "admin"
    EXECUTE_AGENTIC = "execute_agentic"
    VIEW_ANALYTICS = "view_analytics"

# –ú–∞—Ç—Ä–∏—Ü–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
ROLE_PERMISSIONS = {
    Role.ADMIN: {
        Permission.READ,
        Permission.WRITE,
        Permission.DELETE,
        Permission.ADMIN,
        Permission.EXECUTE_AGENTIC,
        Permission.VIEW_ANALYTICS
    },
    Role.USER: {
        Permission.READ,
        Permission.WRITE,
        Permission.EXECUTE_AGENTIC
    },
    Role.VIEWER: {
        Permission.READ,
        Permission.VIEW_ANALYTICS
    },
    Role.API_CLIENT: {
        Permission.READ,
        Permission.EXECUTE_AGENTIC
    }
}

def require_permission(permission: Permission):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π"""
    def decorator(func):
        @wraps(func)
        async def wrapper(request, *args, **kwargs):
            user = request.user
            user_role = Role(user.role)
            
            if permission not in ROLE_PERMISSIONS.get(user_role, set()):
                raise PermissionError(f"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è {permission.value}")
                
            return await func(request, *args, **kwargs)
        return wrapper
    return decorator

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
@require_permission(Permission.EXECUTE_AGENTIC)
async def execute_agentic_rag(request, query: str):
    """–¢–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–æ–º EXECUTE_AGENTIC"""
    return await agentic_rag.process(query)
```

## –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–æ–∫–æ–µ (At Rest)

```python
# security/encryption.py
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2
import base64
import os

class EncryptionManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö"""
    
    def __init__(self, master_key: str = None):
        if master_key:
            self.cipher = Fernet(master_key)
        else:
            self.cipher = Fernet(Fernet.generate_key())
            
    @classmethod
    def derive_key(cls, password: str, salt: bytes = None) -> bytes:
        """–î–µ—Ä–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞ –∏–∑ –ø–∞—Ä–æ–ª—è"""
        if salt is None:
            salt = os.urandom(16)
            
        kdf = PBKDF2(
            algorithm=hashes.SHA256(),
            length=32,
            salt=salt,
            iterations=100000,
        )
        key = base64.urlsafe_b64encode(kdf.derive(password.encode()))
        return key
        
    def encrypt(self, data: str) -> str:
        """–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö"""
        return self.cipher.encrypt(data.encode()).decode()
        
    def decrypt(self, encrypted_data: str) -> str:
        """–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö"""
        return self.cipher.decrypt(encrypted_data.encode()).decode()
        
    def encrypt_field(self, value: Any, field_type: str = "string") -> str:
        """–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—è –ë–î"""
        if field_type == "json":
            value = json.dumps(value)
        return self.encrypt(str(value))
        
    def decrypt_field(self, encrypted_value: str, field_type: str = "string") -> Any:
        """–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—è –ë–î"""
        decrypted = self.decrypt(encrypted_value)
        
        if field_type == "json":
            return json.loads(decrypted)
        elif field_type == "int":
            return int(decrypted)
        elif field_type == "float":
            return float(decrypted)
        return decrypted
```

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–µ—Ä–µ–¥–∞—á–µ (In Transit)

```nginx
# nginx/ssl.conf
server {
    listen 443 ssl http2;
    server_name api.hybrid-rag.ru;
    
    # SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    # –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSL
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    
    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/nginx/ssl/chain.pem;
    
    location / {
        proxy_pass http://hybrid-rag:8000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## –ó–∞—â–∏—Ç–∞ API

### Rate Limiting

```python
# security/rate_limiting.py
from typing import Optional
import time
import redis
from functools import wraps

class RateLimiter:
    """Rate limiter –Ω–∞ –æ—Å–Ω–æ–≤–µ Redis"""
    
    def __init__(self, redis_client: redis.Redis):
        self.redis = redis_client
        
    def is_allowed(
        self, 
        key: str, 
        max_requests: int, 
        window: int
    ) -> tuple[bool, Optional[int]]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤"""
        current = int(time.time())
        window_start = current - window
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
        self.redis.zremrangebyscore(key, 0, window_start)
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –≤ –æ–∫–Ω–µ
        request_count = self.redis.zcard(key)
        
        if request_count < max_requests:
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
            self.redis.zadd(key, {str(current): current})
            self.redis.expire(key, window)
            return True, None
        else:
            # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –¥–æ —Å–±—Ä–æ—Å–∞
            oldest = self.redis.zrange(key, 0, 0, withscores=True)
            if oldest:
                reset_time = int(oldest[0][1]) + window - current
                return False, reset_time
            return False, window

def rate_limit(max_requests: int = 60, window: int = 60):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è rate limiting"""
    def decorator(func):
        @wraps(func)
        async def wrapper(request, *args, **kwargs):
            # –ü–æ–ª—É—á–∞–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞
            client_id = request.headers.get("X-API-Key") or request.client.host
            key = f"rate_limit:{client_id}:{func.__name__}"
            
            allowed, retry_after = rate_limiter.is_allowed(
                key, max_requests, window
            )
            
            if not allowed:
                raise HTTPException(
                    status_code=429,
                    detail="Rate limit exceeded",
                    headers={"Retry-After": str(retry_after)}
                )
                
            return await func(request, *args, **kwargs)
        return wrapper
    return decorator
```

### API Key Management

```python
# security/api_keys.py
import secrets
import hashlib
from datetime import datetime, timedelta
from typing import Optional, List

class APIKeyManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä API –∫–ª—é—á–µ–π"""
    
    def __init__(self, db_session):
        self.db = db_session
        
    def generate_api_key(
        self, 
        user_id: str, 
        name: str,
        permissions: List[str],
        expires_in: Optional[timedelta] = None
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ API –∫–ª—é—á–∞"""
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á
        raw_key = secrets.token_urlsafe(32)
        
        # –•–µ—à–∏—Ä—É–µ–º –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
        key_hash = hashlib.sha256(raw_key.encode()).hexdigest()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
        api_key = APIKey(
            user_id=user_id,
            name=name,
            key_hash=key_hash,
            permissions=permissions,
            expires_at=datetime.utcnow() + expires_in if expires_in else None,
            created_at=datetime.utcnow(),
            last_used=None
        )
        self.db.add(api_key)
        self.db.commit()
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—ã—Ä–æ–π –∫–ª—é—á (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
        return raw_key
        
    def validate_api_key(self, raw_key: str) -> Optional[APIKey]:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è API –∫–ª—é—á–∞"""
        key_hash = hashlib.sha256(raw_key.encode()).hexdigest()
        
        api_key = self.db.query(APIKey).filter(
            APIKey.key_hash == key_hash
        ).first()
        
        if not api_key:
            return None
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è
        if api_key.expires_at and api_key.expires_at < datetime.utcnow():
            return None
            
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        api_key.last_used = datetime.utcnow()
        self.db.commit()
        
        return api_key
        
    def revoke_api_key(self, key_id: str) -> bool:
        """–û—Ç–∑—ã–≤ API –∫–ª—é—á–∞"""
        api_key = self.db.query(APIKey).filter(
            APIKey.id == key_id
        ).first()
        
        if api_key:
            api_key.revoked = True
            api_key.revoked_at = datetime.utcnow()
            self.db.commit()
            return True
        return False
```

### Input Validation

```python
# security/validation.py
from pydantic import BaseModel, validator, Field
from typing import Optional, List
import re
import bleach

class QueryInput(BaseModel):
    """–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    query: str = Field(..., min_length=1, max_length=10000)
    language: str = Field("ru", regex="^[a-z]{2}$")
    max_tokens: int = Field(2000, ge=1, le=10000)
    temperature: float = Field(0.7, ge=0.0, le=1.0)
    
    @validator('query')
    def sanitize_query(cls, v):
        """–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞"""
        # –£–¥–∞–ª—è–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ HTML —Ç–µ–≥–∏
        v = bleach.clean(v, tags=[], strip=True)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ SQL injection –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        sql_patterns = [
            r"(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER)\b)",
            r"(--|#|/\*|\*/)",
            r"(\bUNION\b.*\bSELECT\b)"
        ]
        
        for pattern in sql_patterns:
            if re.search(pattern, v, re.IGNORECASE):
                raise ValueError("–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω")
                
        return v
        
    @validator('max_tokens')
    def validate_tokens_limit(cls, v, values):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏"""
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_role = values.get('user_role', 'user')
        
        if user_role == 'user' and v > 5000:
            raise ValueError("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –≤–∞—à–µ–π —Ä–æ–ª–∏")
            
        return v
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### Docker Security

```dockerfile
# Dockerfile —Å best practices –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
FROM python:3.11-slim AS builder

# –°–æ–∑–¥–∞–µ–º –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN useradd -m -u 1000 appuser && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc \
        libpq-dev && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ requirements
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# Production –æ–±—Ä–∞–∑
FROM python:3.11-slim

# –ö–æ–ø–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ builder
COPY --from=builder /etc/passwd /etc/passwd
COPY --from=builder /etc/group /etc/group

# –ö–æ–ø–∏—Ä—É–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY --from=builder --chown=appuser:appuser /home/appuser/.local /home/appuser/.local

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
COPY --chown=appuser:appuser . .

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER appuser

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health')"

# –ó–∞–ø—É—Å–∫ –æ—Ç –Ω–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Kubernetes Security

```yaml
# k8s/security-policies.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: hybrid-rag-sa
  namespace: hybrid-rag
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: hybrid-rag
  name: hybrid-rag-role
rules:
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: hybrid-rag-rolebinding
  namespace: hybrid-rag
subjects:
  - kind: ServiceAccount
    name: hybrid-rag-sa
    namespace: hybrid-rag
roleRef:
  kind: Role
  name: hybrid-rag-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: policy/v1
kind: PodSecurityPolicy
metadata:
  name: hybrid-rag-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  requiredDropCapabilities:
    - ALL
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
  runAsUser:
    rule: 'MustRunAsNonRoot'
  seLinux:
    rule: 'RunAsAny'
  fsGroup:
    rule: 'RunAsAny'
  readOnlyRootFilesystem: true
```

### Network Security

```yaml
# k8s/network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: hybrid-rag-netpol
  namespace: hybrid-rag
spec:
  podSelector:
    matchLabels:
      app: hybrid-rag
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
        - podSelector:
            matchLabels:
              app: frontend
      ports:
        - protocol: TCP
          port: 8000
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: databases
      ports:
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 6379  # Redis
    - to:
        - podSelector:
            matchLabels:
              app: qdrant
      ports:
        - protocol: TCP
          port: 6333
```

## –ê—É–¥–∏—Ç –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Audit Logging

```python
# security/audit.py
import json
from datetime import datetime
from typing import Dict, Any, Optional
from enum import Enum

class AuditEventType(Enum):
    """–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞"""
    LOGIN = "login"
    LOGOUT = "logout"
    API_CALL = "api_call"
    DATA_ACCESS = "data_access"
    DATA_MODIFICATION = "data_modification"
    PERMISSION_CHANGE = "permission_change"
    SECURITY_ALERT = "security_alert"

class AuditLogger:
    """–°–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç–∞"""
    
    def __init__(self, storage):
        self.storage = storage
        
    async def log_event(
        self,
        event_type: AuditEventType,
        user_id: Optional[str],
        details: Dict[str, Any],
        ip_address: Optional[str] = None,
        user_agent: Optional[str] = None
    ):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è"""
        event = {
            "timestamp": datetime.utcnow().isoformat(),
            "event_type": event_type.value,
            "user_id": user_id,
            "ip_address": ip_address,
            "user_agent": user_agent,
            "details": details
        }
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
        await self.storage.save_audit_event(event)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
        if event_type == AuditEventType.SECURITY_ALERT:
            await self._handle_security_alert(event)
            
    async def _handle_security_alert(self, event: Dict[str, Any]):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ security –∞–ª–µ—Ä—Ç–æ–≤"""
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        await notification_service.send_alert(
            title="Security Alert",
            message=json.dumps(event),
            severity="high"
        )
        
        # –í–æ–∑–º–æ–∂–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if event['details'].get('auto_block'):
            await user_service.block_user(event['user_id'])
```

### Security Monitoring

```python
# monitoring/security_metrics.py
from prometheus_client import Counter, Histogram

# –ú–µ—Ç—Ä–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
failed_auth_counter = Counter(
    'security_failed_auth_total',
    '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏',
    ['method', 'reason']
)

suspicious_activity_counter = Counter(
    'security_suspicious_activity_total',
    '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π',
    ['type', 'severity']
)

api_key_usage = Counter(
    'security_api_key_usage_total',
    '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API –∫–ª—é—á–µ–π',
    ['key_id', 'endpoint']
)

encryption_operations = Histogram(
    'security_encryption_duration_seconds',
    '–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è',
    ['operation']
)
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏

### HashiCorp Vault Integration

```python
# security/vault.py
import hvac
from typing import Dict, Any, Optional

class VaultManager:
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å HashiCorp Vault"""
    
    def __init__(self, vault_url: str, token: str):
        self.client = hvac.Client(url=vault_url, token=token)
        
        if not self.client.is_authenticated():
            raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ Vault")
            
    def get_secret(self, path: str) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞"""
        response = self.client.secrets.kv.v2.read_secret_version(
            path=path,
            mount_point="secret"
        )
        return response['data']['data']
        
    def store_secret(self, path: str, secret: Dict[str, Any]):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞"""
        self.client.secrets.kv.v2.create_or_update_secret(
            path=path,
            secret=secret,
            mount_point="secret"
        )
        
    def rotate_database_credentials(self, database: str) -> Dict[str, str]:
        """–†–æ—Ç–∞—Ü–∏—è credentials –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        response = self.client.secrets.database.generate_credentials(
            name=database
        )
        return {
            "username": response['data']['username'],
            "password": response['data']['password']
        }
```

### Environment Variables Security

```python
# security/env_manager.py
import os
from typing import Optional
from cryptography.fernet import Fernet

class SecureEnvironment:
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
    
    def __init__(self, key_file: str = ".env.key"):
        self.key = self._load_or_generate_key(key_file)
        self.cipher = Fernet(self.key)
        
    def _load_or_generate_key(self, key_file: str) -> bytes:
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è"""
        if os.path.exists(key_file):
            with open(key_file, 'rb') as f:
                return f.read()
        else:
            key = Fernet.generate_key()
            with open(key_file, 'wb') as f:
                f.write(key)
            os.chmod(key_file, 0o600)  # –¢–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
            return key
            
    def get_secure_env(self, key: str, encrypted: bool = False) -> Optional[str]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        value = os.getenv(key)
        
        if value and encrypted:
            # –î–µ—à–∏—Ñ—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            value = self.cipher.decrypt(value.encode()).decode()
            
        return value
        
    def set_secure_env(self, key: str, value: str, encrypt: bool = False):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
        if encrypt:
            value = self.cipher.encrypt(value.encode()).decode()
            
        os.environ[key] = value
```

## –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫

### SQL Injection Prevention

```python
# security/sql_protection.py
from sqlalchemy import text
from typing import Any, Dict

class SafeQueryBuilder:
    """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å SQL –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    @staticmethod
    def safe_query(query_template: str, params: Dict[str, Any]):
        """–ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞"""
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        stmt = text(query_template)
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        for key, value in params.items():
            if isinstance(value, str):
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
                if any(danger in value.upper() for danger in [
                    'DROP', 'DELETE', 'INSERT', 'UPDATE', '--', '/*'
                ]):
                    raise ValueError(f"–û–ø–∞—Å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ {key}")
                    
        return stmt, params
```

### XSS Prevention

```python
# security/xss_protection.py
import bleach
from markupsafe import escape

class XSSProtection:
    """–ó–∞—â–∏—Ç–∞ –æ—Ç XSS –∞—Ç–∞–∫"""
    
    ALLOWED_TAGS = ['p', 'br', 'strong', 'em', 'u', 'a']
    ALLOWED_ATTRIBUTES = {'a': ['href', 'title']}
    
    @classmethod
    def sanitize_html(cls, html: str) -> str:
        """–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML"""
        return bleach.clean(
            html,
            tags=cls.ALLOWED_TAGS,
            attributes=cls.ALLOWED_ATTRIBUTES,
            strip=True
        )
        
    @classmethod
    def escape_output(cls, text: str) -> str:
        """–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞"""
        return escape(text)
```

### CSRF Protection

```python
# security/csrf.py
import secrets
from fastapi import Request, HTTPException
from typing import Optional

class CSRFProtection:
    """–ó–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫"""
    
    def __init__(self, secret_key: str):
        self.secret_key = secret_key
        
    def generate_token(self) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSRF —Ç–æ–∫–µ–Ω–∞"""
        return secrets.token_urlsafe(32)
        
    def validate_token(self, request: Request, token: Optional[str]) -> bool:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è CSRF —Ç–æ–∫–µ–Ω–∞"""
        session_token = request.session.get('csrf_token')
        
        if not session_token or not token:
            return False
            
        return secrets.compare_digest(session_token, token)
        
    async def csrf_protect(self, request: Request):
        """Middleware –¥–ª—è CSRF –∑–∞—â–∏—Ç—ã"""
        if request.method in ['POST', 'PUT', 'DELETE', 'PATCH']:
            token = request.headers.get('X-CSRF-Token')
            
            if not self.validate_token(request, token):
                raise HTTPException(
                    status_code=403,
                    detail="CSRF token validation failed"
                )
```

## Compliance –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

### GDPR Compliance

```python
# compliance/gdpr.py
from typing import Dict, Any, List
from datetime import datetime

class GDPRCompliance:
    """–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è GDPR"""
    
    async def export_user_data(self, user_id: str) -> Dict[str, Any]:
        """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Right to Access)"""
        data = {
            "user_info": await self._get_user_info(user_id),
            "queries": await self._get_user_queries(user_id),
            "documents": await self._get_user_documents(user_id),
            "audit_log": await self._get_user_audit_log(user_id)
        }
        
        return data
        
    async def delete_user_data(self, user_id: str) -> bool:
        """–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Right to be Forgotten)"""
        # –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞—É–¥–∏—Ç–∞
        await self._anonymize_user_data(user_id)
        
        # –£–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        await self._delete_personal_data(user_id)
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        await audit_logger.log_event(
            AuditEventType.DATA_MODIFICATION,
            user_id=user_id,
            details={"action": "gdpr_deletion"}
        )
        
        return True
        
    async def get_consent_status(self, user_id: str) -> Dict[str, bool]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–≥–ª–∞—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        return {
            "data_processing": await self._check_consent(user_id, "data_processing"),
            "marketing": await self._check_consent(user_id, "marketing"),
            "analytics": await self._check_consent(user_id, "analytics"),
            "third_party": await self._check_consent(user_id, "third_party")
        }
```

### SOC2 Compliance

```python
# compliance/soc2.py
class SOC2Compliance:
    """–û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è SOC2"""
    
    def __init__(self):
        self.controls = {
            "CC1.1": "Logical Access Controls",
            "CC1.2": "User Access Provisioning",
            "CC1.3": "User Authentication",
            "CC2.1": "Baseline Configuration",
            "CC2.2": "Change Management",
            "CC2.3": "System Monitoring",
            "CC3.1": "Data at Rest Encryption",
            "CC3.2": "Data in Transit Encryption",
            "CC4.1": "Environmental Protection",
            "CC4.2": "Physical Access Controls"
        }
        
    async def audit_control(self, control_id: str) -> Dict[str, Any]:
        """–ê—É–¥–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è"""
        if control_id not in self.controls:
            raise ValueError(f"Unknown control: {control_id}")
            
        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è
        result = await self._check_control(control_id)
        
        return {
            "control_id": control_id,
            "description": self.controls[control_id],
            "status": result["status"],
            "evidence": result["evidence"],
            "timestamp": datetime.utcnow().isoformat()
        }
```

## Incident Response

### –ü–ª–∞–Ω —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã

```python
# security/incident_response.py
from enum import Enum
from typing import List, Dict, Any

class IncidentSeverity(Enum):
    """–£—Ä–æ–≤–Ω–∏ —Å–µ—Ä—å–µ–∑–Ω–æ—Å—Ç–∏ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤"""
    CRITICAL = "critical"  # –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –≤–∑–ª–æ–º
    HIGH = "high"         # –ü–æ–ø—ã—Ç–∫–∞ –≤–∑–ª–æ–º–∞, DoS
    MEDIUM = "medium"     # –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    LOW = "low"           # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ

class IncidentResponse:
    """–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã"""
    
    def __init__(self):
        self.response_team = {
            IncidentSeverity.CRITICAL: ["cto@mixbase.ru", "security@mixbase.ru"],
            IncidentSeverity.HIGH: ["security@mixbase.ru", "devops@mixbase.ru"],
            IncidentSeverity.MEDIUM: ["devops@mixbase.ru"],
            IncidentSeverity.LOW: ["monitoring@mixbase.ru"]
        }
        
    async def report_incident(
        self,
        severity: IncidentSeverity,
        description: str,
        affected_systems: List[str],
        evidence: Dict[str, Any]
    ):
        """–†–µ–ø–æ—Ä—Ç–∏–Ω–≥ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞"""
        incident = {
            "id": self._generate_incident_id(),
            "severity": severity.value,
            "description": description,
            "affected_systems": affected_systems,
            "evidence": evidence,
            "reported_at": datetime.utcnow().isoformat(),
            "status": "open"
        }
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
        await self._save_incident(incident)
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
        await self._notify_response_team(incident)
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
        if severity in [IncidentSeverity.CRITICAL, IncidentSeverity.HIGH]:
            await self._initiate_automatic_response(incident)
            
        return incident["id"]
        
    async def _initiate_automatic_response(self, incident: Dict[str, Any]):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ"""
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö IP
        if "ip_addresses" in incident["evidence"]:
            for ip in incident["evidence"]["ip_addresses"]:
                await firewall.block_ip(ip)
                
        # –û—Ç–∑—ã–≤ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª—é—á–µ–π
        if "api_keys" in incident["evidence"]:
            for key in incident["evidence"]["api_keys"]:
                await api_key_manager.revoke_api_key(key)
                
        # –í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        await logging_service.set_level("DEBUG")
```

## –ß–µ–∫–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### Pre-Production —á–µ–∫–ª–∏—Å—Ç

```yaml
# security-checklist.yaml
authentication:
  - [ ] JWT —Ç–æ–∫–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å–µ–∫—Ä–µ—Ç–æ–º
  - [ ] Refresh —Ç–æ–∫–µ–Ω—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
  - [ ] OAuth 2.0 –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
  - [ ] MFA –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

authorization:
  - [ ] RBAC –Ω–∞—Å—Ç—Ä–æ–µ–Ω
  - [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –≤—Å–µ endpoints
  - [ ] –ü—Ä–∏–Ω—Ü–∏–ø –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π

encryption:
  - [ ] TLS 1.2+ –¥–ª—è –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  - [ ] –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–æ–∫–æ–µ –¥–ª—è –ë–î
  - [ ] –ö–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

api_security:
  - [ ] Rate limiting –≤–∫–ª—é—á–µ–Ω
  - [ ] Input validation –Ω–∞ –≤—Å–µ—Ö endpoints
  - [ ] CORS –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
  - [ ] API –∫–ª—é—á–∏ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã

infrastructure:
  - [ ] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ—Ç non-root
  - [ ] Network policies –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
  - [ ] Security groups –º–∏–Ω–∏–º–∞–ª—å–Ω—ã
  - [ ] Secrets –≤ Kubernetes –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã

monitoring:
  - [ ] –ê—É–¥–∏—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ
  - [ ] Security –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
  - [ ] –ê–ª–µ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
  - [ ] SIEM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

compliance:
  - [ ] GDPR –ø—Ä–æ—Ü–µ—Å—Å—ã –≤–Ω–µ–¥—Ä–µ–Ω—ã
  - [ ] Data retention –ø–æ–ª–∏—Ç–∏–∫–∞
  - [ ] Backup —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
  - [ ] Disaster recovery –ø–ª–∞–Ω

vulnerabilities:
  - [ ] Dependency scanning –≤ CI/CD
  - [ ] Container scanning
  - [ ] SAST/DAST —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  - [ ] Penetration testing –ø—Ä–æ–≤–µ–¥–µ–Ω
```

### Production —á–µ–∫–ª–∏—Å—Ç

```bash
#!/bin/bash
# security-check.sh - –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

echo "üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Hybrid RAG System..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
echo "Checking SSL certificates..."
openssl s_client -connect api.hybrid-rag.ru:443 -servername api.hybrid-rag.ru < /dev/null

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤
echo "Checking open ports..."
nmap -sT api.hybrid-rag.ru

# –ü—Ä–æ–≤–µ—Ä–∫–∞ headers –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
echo "Checking security headers..."
curl -I https://api.hybrid-rag.ru | grep -E "(Strict-Transport|X-Frame|X-Content|CSP)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
echo "Scanning dependencies..."
safety check
pip-audit

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
echo "Scanning Docker images..."
trivy image hybrid-rag:latest

echo "‚úÖ Security check completed!"
```

---

**–í–∞–∂–Ω–æ**: –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã, –ø—Ä–æ–≤–æ–¥–∏—Ç–µ security –∞—É–¥–∏—Ç—ã –∏ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ CVE —É—è–∑–≤–∏–º–æ—Å—Ç—è–º–∏ –≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - —ç—Ç–æ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –∞ –Ω–µ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞.
